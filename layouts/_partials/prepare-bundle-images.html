{{/*
  Home page helper: returns a normalized slice of dict items
  for rendering by image-grid.html.

  Input:
    - page/section/etc to get resources from as .

  Output item shape (normalized):
    - src: string (original image URL)
    - small: string (optional, URL for small- variant or thumbnail- fallback)
    - medium: string (optional, URL for medium- variant)
    - href: string (link target for the tile)
    - alt: string (resource Title or filename without extension)
*/}}

{{ $page := . }}

{{ $items := slice }}
{{/* Collect this page's image resources */}}
{{ $imgs := $page.Resources.ByType "image" }}

{{/* Build variant indexes: key = original filename (lower, with ext)
     This enforces that small-/medium- variants only match originals
     with the same basename AND extension. */}}
{{ $smallIndex := dict }}
{{ $mediumIndex := dict }}
{{ $altIndex := dict }}
{{ range $imgs }}
  {{ $lname := lower .Name }}
  {{ if hasPrefix $lname "small-" }}
    {{ $orig := replaceRE "^small-(.+)$" "$1" $lname }}
    {{ $smallIndex = merge $smallIndex (dict $orig .) }}
  {{ else if hasPrefix $lname "medium-" }}
    {{ $orig := replaceRE "^medium-(.+)$" "$1" $lname }}
    {{ $mediumIndex = merge $mediumIndex (dict $orig .) }}
  {{ else if hasPrefix $lname "alt-" }}
    {{ $orig := replaceRE "^alt-(.+)$" "$1" $lname }}
    {{ $base := lower (replaceRE "\\.[^.]+$" "" $orig) }}
    {{ $altIndex = merge $altIndex (dict $base .) }}
  {{ end }}
{{ end }}

{{ range $imgs }}
  {{ $name := .Name }}
  {{ $lname := lower $name }}
  {{ if and (not (hasPrefix $lname "small-")) (not (hasPrefix $lname "medium-")) (not (hasPrefix $lname "alt-")) }}
    {{ $src := .RelPermalink }}
    {{ $small := "" }}
    {{ with index $smallIndex $lname }}{{ $small = .RelPermalink }}{{ end }}
    {{ $medium := "" }}
    {{ with index $mediumIndex $lname }}{{ $medium = .RelPermalink }}{{ end }}
    {{ $alt := cond (ne .Title "") .Title (replaceRE "\\.[^.]+$" "" $name) }}
    {{ $dict := dict "src" $src "href" .RelPermalink "alt" $alt }}
    {{ if ne $small "" }}{{ $dict = merge $dict (dict "small" $small) }}{{ end }}
    {{ if ne $medium "" }}{{ $dict = merge $dict (dict "medium" $medium) }}{{ end }}
    {{/* Attach alternate fallback format when available (different extension). */}}
    {{ $base := lower (replaceRE "\\.[^.]+$" "" $lname) }}
    {{ with index $altIndex $base }}
      {{ $altRes := . }}
      {{ $origExt := lower (replaceRE "^.+\\.([^.]+)$" "$1" $lname) }}
      {{ $altName := lower $altRes.Name }}
      {{ $altExt := lower (replaceRE "^.+\\.([^.]+)$" "$1" $altName) }}
      {{ if ne $altExt $origExt }}
        {{ $mime := cond (or (eq $altExt "jpg") (eq $altExt "jpeg")) "image/jpeg" (printf "image/%s" $altExt) }}
        {{ $dict = merge $dict (dict "altFormat" (dict "src" $altRes.RelPermalink "type" $mime)) }}
      {{ end }}
    {{ end }}
    {{ $items = $items | append $dict }}
  {{ end }}
{{ end }}


{{ return $items }}
