{{/*
  Home page helper: returns a normalized slice of dict items
  for rendering by image-grid.html.

  Input:
    - page/section/etc to get resources from as .

  Output item shape (normalized):
    - src: string (thumbnail if available, else original)
    - href: string (link to the containing page)
    - alt: string (resource Title or filename without extension)
*/}}

{{ $page := . }}

{{ $items := slice }}
{{/* Collect this page's image resources */}}
{{ $imgs := $page.Resources.ByType "image" }}

{{/* Build thumbnail index: key = base name (lower, no ext) */}}
{{ $thumbIndex := dict }}
{{ range $imgs }}
  {{ $lname := lower .Name }}
  {{ if hasPrefix $lname "thumbnail-" }}
    {{ $base := replaceRE "^thumbnail-(.+)\\..+$" "$1" $lname }}
    {{ $thumbIndex = merge $thumbIndex (dict $base .) }}
  {{ end }}
{{ end }}

{{ range $imgs }}
  {{ $name := .Name }}
  {{ if not (hasPrefix (lower $name) "thumbnail-") }}
    {{ $base := lower (replaceRE "\\.[^.]+$" "" $name) }}
    {{ $src := .RelPermalink }}
    {{ with index $thumbIndex $base }}{{ $src = .RelPermalink }}{{ end }}
    {{ $alt := cond (ne .Title "") .Title (replaceRE "\\.[^.]+$" "" $name) }}
    {{ $items = $items | append (dict "src" $src "href" .RelPermalink "alt" $alt) }}
  {{ end }}
{{ end }}


{{ return $items }}
