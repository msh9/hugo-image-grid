{{/*
  prepare-feature-image: returns a normalized slice of dict items
  for rendering by image-grid.html. From a single child

  Input dict:
    - The page to get resources from passed as .

  Output items:
    - src: original image URL to display
    - small: optional URL for small- variant (or thumbnail- fallback)
    - medium: optional URL for medium- variant
    - href: link target (image URL for list pages)
    - alt: alt text (title or filename)
*/}}

{{ $page := . }}

{{ $items := slice }}

{{ $imgs := $page.Resources.ByType "image" }}
{{/* variant indexes for page (prefix-based)
     Keys are original filenames (lowercase, WITH extension) to ensure
     only same-extension variants are paired. */}}
{{ $smallIndex := dict }}
{{ $mediumIndex := dict }}
{{ $altIndex := dict }}
{{ $candidates := slice }}

{{ range $imgs }}
  {{ $lname := lower .Name }}
  {{ if hasPrefix $lname "small-" }}
    {{ $orig := replaceRE "^small-(.+)$" "$1" $lname }}
    {{ $smallIndex = merge $smallIndex (dict $orig .) }}
  {{ else if hasPrefix $lname "medium-" }}
    {{ $orig := replaceRE "^medium-(.+)$" "$1" $lname }}
    {{ $mediumIndex = merge $mediumIndex (dict $orig .) }}
  {{ else if hasPrefix $lname "alt-" }}
    {{ $orig := replaceRE "^alt-(.+)$" "$1" $lname }}
    {{ $base := lower (replaceRE "\\.[^.]+$" "" $orig) }}
    {{ $altIndex = merge $altIndex (dict $base .) }}
  {{ else }}
    {{ $candidates = $candidates | append . }}
  {{ end }}
{{ end }}

{{ $sorted := sort $candidates "Name" "asc" }}
{{ with index $sorted 0 }}
  {{ $featuredImage := . }}
  {{ $name := $featuredImage.Name }}
  {{ $key := lower $name }}
  {{ $base := lower (replaceRE "\\.[^.]+$" "" $name) }}
  {{ $src := $featuredImage.RelPermalink }}
  {{ $small := "" }}
  {{ with index $smallIndex $key }}{{ $small = .RelPermalink }}{{ end }}
  {{ $medium := "" }}
  {{ with index $mediumIndex $key }}{{ $medium = .RelPermalink }}{{ end }}
  {{ $alt := cond (ne $featuredImage.Title "") $featuredImage.Title $base }}
  {{ $dict := dict "src" $src "href" $page.RelPermalink "alt" $alt }}
  {{ if ne $small "" }}{{ $dict = merge $dict (dict "small" $small) }}{{ end }}
  {{ if ne $medium "" }}{{ $dict = merge $dict (dict "medium" $medium) }}{{ end }}
  {{/* Attach alternate fallback format when available (different extension). */}}
  {{ $baseKey := lower (replaceRE "\\.[^.]+$" "" $key) }}
  {{ with index $altIndex $baseKey }}
    {{ $altRes := . }}
    {{ $origExt := lower (replaceRE "^.+\\.([^.]+)$" "$1" $key) }}
    {{ $altName := lower $altRes.Name }}
    {{ $altExt := lower (replaceRE "^.+\\.([^.]+)$" "$1" $altName) }}
    {{ if ne $altExt $origExt }}
      {{ $mime := cond (or (eq $altExt "jpg") (eq $altExt "jpeg")) "image/jpeg" (printf "image/%s" $altExt) }}
      {{ $dict = merge $dict (dict "altFormat" (dict "src" $altRes.RelPermalink "type" $mime)) }}
    {{ end }}
  {{ end }}
  {{ $items = $items | append $dict }}
{{ end }}

{{ return $items }}
