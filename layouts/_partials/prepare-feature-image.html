{{/*
  prepare-feature-image: returns a normalized slice of dict items
  for rendering by image-grid.html. From a single child

  Input dict:
    - The page to get resources from passed as .

  Output items:
    - src: image URL to display (thumbnail if available)
    - href: link target (image URL for list pages)
    - alt: alt text (title or filename)
*/}}

{{ $page := . }}

{{ $items := slice }}

{{ $imgs := $page.Resources.ByType "image" }}
{{/* thumbnail index for page (prefix-based) */}}
{{ $thumbIndex := dict }}
{{ $candidates := slice }}

{{ range $imgs }}
  {{ $lname := lower .Name }}
  {{ if hasPrefix $lname "thumbnail-" }}
    {{ $base := replaceRE "^thumbnail-(.+)\\..+$" "$1" $lname }}
    {{ $thumbIndex = merge $thumbIndex (dict $base .) }}
  {{ else }}
    {{ $candidates = $candidates | append . }}
  {{ end }}
{{ end }}

{{ $sorted := sort $candidates "Name" "asc" }}
{{ with index $sorted 0 }}
  {{ $featuredImage := . }}
  {{ $name := $featuredImage.Name }}
  {{ $base := lower (replaceRE "\\.[^.]+$" "" $name) }}
  {{ $src := $featuredImage.RelPermalink }}
  {{ with index $thumbIndex $base }}{{ $src = .RelPermalink }}{{ end }}
  {{ $alt := cond (ne $featuredImage.Title "") $featuredImage.Title (replaceRE "\\.[^.]+$" "" $name) }}
  {{ $items = $items | append (dict "src" $src "href" $page.RelPermalink "alt" $alt) }}
{{ end }}

{{ return $items }}
