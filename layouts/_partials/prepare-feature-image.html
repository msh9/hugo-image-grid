{{/*
  prepare-feature-image: returns a normalized slice of dict items
  for rendering by image-grid.html. From a single child

  Input dict:
    - The page to get resources from passed as .

  Output items:
    - src: original image URL to display
    - small: optional URL for small- variant (or thumbnail- fallback)
    - medium: optional URL for medium- variant
    - href: link target (image URL for list pages)
    - alt: alt text (title or filename)
*/}}

{{ $page := . }}

{{ $items := slice }}

{{ $imgs := $page.Resources.ByType "image" }}
{{/* variant indexes for page (prefix-based) */}}
{{ $smallIndex := dict }}
{{ $mediumIndex := dict }}
{{ $candidates := slice }}

{{ range $imgs }}
  {{ $lname := lower .Name }}
  {{ if hasPrefix $lname "small-" }}
    {{ $base := replaceRE "^small-(.+)\\..+$" "$1" $lname }}
    {{ $smallIndex = merge $smallIndex (dict $base .) }}
  {{ else if hasPrefix $lname "medium-" }}
    {{ $base := replaceRE "^medium-(.+)\\..+$" "$1" $lname }}
    {{ $mediumIndex = merge $mediumIndex (dict $base .) }}
  {{ else }}
    {{ $candidates = $candidates | append . }}
  {{ end }}
{{ end }}

{{ $sorted := sort $candidates "Name" "asc" }}
{{ with index $sorted 0 }}
  {{ $featuredImage := . }}
  {{ $name := $featuredImage.Name }}
  {{ $base := lower (replaceRE "\\.[^.]+$" "" $name) }}
  {{ $src := $featuredImage.RelPermalink }}
  {{ $small := "" }}
  {{ with index $smallIndex $base }}{{ $small = .RelPermalink }}{{ end }}
  {{ $medium := "" }}
  {{ with index $mediumIndex $base }}{{ $medium = .RelPermalink }}{{ end }}
  {{ $alt := cond (ne $featuredImage.Title "") $featuredImage.Title $base }}
  {{ $dict := dict "src" $src "href" $page.RelPermalink "alt" $alt }}
  {{ if ne $small "" }}{{ $dict = merge $dict (dict "small" $small) }}{{ end }}
  {{ if ne $medium "" }}{{ $dict = merge $dict (dict "medium" $medium) }}{{ end }}
  {{ $items = $items | append $dict }}
{{ end }}

{{ return $items }}
