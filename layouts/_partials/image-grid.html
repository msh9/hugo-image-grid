{{/*
  Renders a responsive image grid from a normalized slice of dicts:
    [{ src, href, alt }, ...]
  No lookup or business logic here; callers must normalize.
*/}}

{{ $items := . | default (slice) }}
<ul class="grid" aria-label="Image grid">
  {{ range $items }}
    <li class="grid-item">
      <a href="{{ .href }}">
        <picture>
          {{/* Primary size-aware source with type derived from primary format */}}
          {{ $primaryType := "" }}
          {{ $extSrc := lower (replaceRE "^.+\\.([^.]+)$" "$1" .src) }}
          {{ if or (eq $extSrc "jpg") (eq $extSrc "jpeg") }}
            {{ $primaryType = "image/jpeg" }}
          {{ else }}
            {{ $primaryType = printf "image/%s" $extSrc }}
          {{ end }}
          {{ if and .small .medium }}
            <source type="{{ $primaryType }}" size="(width <= 1024px) 280px, 320px" srcset="{{ .small }} 400w, {{ .medium }} 800w">
          {{ else if .small }}
            <source type="{{ $primaryType }}" size="(width <= 1024px) 280px" srcset="{{ .small }} 400w">
          {{ end }}
          {{/* Alternate fallback format: single original, no size-aware srcset */}}
          {{ $imgSrc := .src }}
          {{ with .altFormat }}
            {{ $imgSrc = .src }}
          {{ end }}
          <img loading="lazy" src="{{ $imgSrc }}" alt="{{ .alt }}" />
        </picture>
      </a>
    </li>
  {{ end }}
</ul>
