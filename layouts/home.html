{{ define "main" }}
  {{ with .Content }}
    <div class="content">{{ . }}</div>
  {{ end }}

  {{ $allowed := slice "jpg" "jpeg" "png" "webp" "avif" "gif" "bmp" }}

  {{ $useFeatured := partialCached "use-featured-images.html" . }}

  {{ $rootImgs := where (.Resources.ByType "image") "MediaType.SubType" "in" $allowed }}
  {{ $rootChildren := slice }}
  {{ range .Sections }}{{ $rootChildren = $rootChildren | append . }}{{ end }}
  {{ range .RegularPages }}{{ $rootChildren = $rootChildren | append . }}{{ end }}

  {{ if gt (len $rootImgs) 0 }}
    <section>
      <h2 class="section-title">Non-Gallery Photos</h2>
      {{ partial "image-grid.html" (dict "images" $rootImgs) }}
    </section>
  {{ end }}
  {{ range $rootChildren }}
    <section>
      <h2 class="section-title"><a href="/">{{ .Title }}</a></h2>
      {{ if $useFeatured }}
        {{ $tiles := slice }}
        {{ range $rootImgs }}{{ $tiles = $tiles | append (dict "img" . "href" .RelPermalink "parent" $) }}{{ end }}
        {{ range $rootChildren }}
          {{ $child := . }}
          {{ $imgs := where ($child.Resources.ByType "image") "MediaType.SubType" "in" $allowed }}
          {{ $candidates := slice }}{{ range $imgs }}{{ if not (in (lower .Name) ".thumbnail." ) }}{{ $candidates = $candidates | append . }}{{ end }}{{ end }}
          {{ $sorted := sort $candidates "Name" "asc" }}
          {{ with index $sorted 0 }}
            {{ $tiles = $tiles | append (dict "img" . "href" $child.RelPermalink "parent" $child) }}
          {{ end }}
        {{ end }}
        {{ if gt (len $tiles) 0 }}
          {{ partial "image-grid.html" (dict "tiles" $tiles) }}
        {{ else }}
          <p>No images found.</p>
        {{ end }}
      {{ else }}
        {{ $images := slice }}
        {{ range $rootImgs }}{{ $images = $images | append . }}{{ end }}
        {{ range $rootChildren }}
          {{ $imgs := where (.Resources.ByType "image") "MediaType.SubType" "in" $allowed }}
          {{ range $imgs }}{{ if not (in (lower .Name) ".thumbnail." ) }}{{ $images = $images | append . }}{{ end }}{{ end }}
        {{ end }}
        {{ if gt (len $images) 0 }}
          {{ partial "image-grid.html" (dict "images" $images) }}
        {{ else }}
          <p>No images found.</p>
        {{ end }}
      {{ end }}
    </section>
  {{ end }}
{{ end }}