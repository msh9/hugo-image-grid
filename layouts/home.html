{{ define "main" }}
  {{ with .Content }}
    <div class="content">{{ . }}</div>
  {{ end }}

  {{ $useFeatured := partialCached "use-featured-images.html" . }}

  {{/* Home root images */}}
  {{ $rootItems := partial "home-grid-items.html" (dict "page" . "mode" "images") }}
  <section>
    <h2 class="section-title">Non-Gallery Photos</h2>
    {{ partial "image-grid.html" $rootItems }}
  </section>

  {{/* Immediate child galleries: direct subsections + direct regular pages */}}
  {{ $rootChildren := slice }}
  {{ range .Sections }}{{ $rootChildren = $rootChildren | append . }}{{ end }}
  {{ range .RegularPages }}{{ $rootChildren = $rootChildren | append . }}{{ end }}

  {{ range $rootChildren }}
    {{ $child := . }}
    <section>
      <h2 class="section-title"><a href="{{ $child.RelPermalink }}">{{ .Title }}</a></h2>
      {{ $items := nil }}
      {{ if $useFeatured }}
        {{ $items = partial "home-grid-items.html" (dict "page" $child "mode" "featured") }}
      {{ else }}
        {{ $items = partial "home-grid-items.html" (dict "page" $child "mode" "images") }}
      {{ end }}
      {{ partial "image-grid.html" $items }}
    </section>
  {{ end }}
{{ end }}
