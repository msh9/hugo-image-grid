{{ define "main" }}
  {{ with .Content }}
    <div class="content">{{ . }}</div>
  {{ end }}

  {{/* Group by top-level sections; for each section show all images in that section and its descendants */}}
  {{ $allowed := slice "jpg" "jpeg" "png" "webp" "avif" "gif" "bmp" }}

  {{ range site.Sections }}
    {{ $sec := . }}
    <section class="home-section">
      <h2 class="page-title"><a href="{{ $sec.RelPermalink }}">{{ $sec.Title }}</a></h2>
      {{ with $sec.Description }}<p class="content">{{ . }}</p>{{ end }}

      {{ $scratch := newScratch }}
      {{ $scratch.Set "images" (slice) }}

      {{/* Add images from the section bundle itself */}}
      {{ with $sec.Resources.ByType "image" }}
        {{ $scratch.Add "images" . }}
      {{ end }}

      {{/* Add images from all descendant regular pages */}}
      {{ range $sec.RegularPagesRecursive }}
        {{ with .Resources.ByType "image" }}
          {{ $scratch.Add "images" . }}
        {{ end }}
      {{ end }}

      {{/* Filter to supported extensions only */}}
      {{ $images := where ($scratch.Get "images") "MediaType.SubType" "in" $allowed }}

      {{ if gt (len $images) 0 }}
        {{ partial "image-grid.html" (dict "images" $images) }}
      {{ else }}
        <p>No images found in this section.</p>
      {{ end }}
    </section>
  {{ end }}
{{ end }}
