{{ define "main" }}
  {{ with .Content }}
    <div class="content">{{ . }}</div>
  {{ end }}

  {{ $useFeatured := partialCached "use-featured-images.html" . }}

  {{/* Home root images */}}
  {{ $rootItems := partial "home-grid-items.html" (dict "page" . "mode" "images") }}
  {{ if gt (len $rootItems) 0 }}
    <section>
      <h2 class="section-title">Non-Gallery Photos</h2>
      {{ partial "image-grid.html" $rootItems }}
    </section>
  {{ end }}

  {{/* Immediate child galleries: direct subsections + direct regular pages */}}
  {{ $rootChildren := slice }}
  {{ range .Sections }}{{ $rootChildren = $rootChildren | append . }}{{ end }}
  {{ range .RegularPages }}{{ $rootChildren = $rootChildren | append . }}{{ end }}

  {{ range $rootChildren }}
    {{ $child := . }}
    <section>
      <h2 class="section-title"><a href="{{ $child.RelPermalink }}">{{ .Title }}</a></h2>
      {{ if $useFeatured }}
        {{ $items := partial "home-grid-items.html" (dict "page" $child "mode" "featured") }}
        {{ if gt (len $items) 0 }}{{ partial "image-grid.html" $items }}{{ end }}
      {{ else }}
        {{ $items := partial "home-grid-items.html" (dict "page" $child "mode" "images") }}
        {{ if gt (len $items) 0 }}{{ partial "image-grid.html" $items }}{{ end }}
      {{ end }}
    </section>
  {{ end }}
{{ end }}
