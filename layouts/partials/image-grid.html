{{/*
  Renders a responsive image grid.
  Usage: {{ partial "image-grid.html" (dict "images" $images) }}
  Where $images is a slice of Page Resources (images only).

  Thumbnail behavior (home/section lists only):
  - If a sibling resource named like "<base>.thumbnail.*" exists, use it as the <img> src.
  - Always link to the original resource (.RelPermalink).
  - Skip resources that are themselves thumbnails (".thumbnail." in filename, case-insensitive).
*/}}
{{ $images := .images | default (slice) }}
{{ $all := $images }}
{{ if gt (len $images) 0 }}
  <ul class="grid" aria-label="Image grid">
    {{ range $images }}
      {{ $name := .Name }}
      {{ $lowerName := lower $name }}
      {{ if not (in $lowerName ".thumbnail.") }}
        {{ $basename := replaceRE "\\.[^.]+$" "" $name }}
        {{ $baseLower := lower $basename }}
        {{ $dir := replaceRE "/[^/]+$" "/" .RelPermalink }}
        {{ $src := .RelPermalink }}
        {{/* Look for a sibling in the same directory whose name starts with "<base>.thumbnail." */}}
        {{ range $all }}
          {{ $cdir := replaceRE "/[^/]+$" "/" .RelPermalink }}
          {{ $cname := lower .Name }}
          {{ if and (eq $cdir $dir) (hasPrefix $cname (printf "%s.thumbnail." $baseLower)) }}
            {{ $src = .RelPermalink }}
          {{ end }}
        {{ end }}
        <li class="grid-item">
          <a href="{{ .RelPermalink }}">
            <img loading="lazy" src="{{ $src }}" alt="{{ with .Title }}{{ . }}{{ else }}{{ replaceRE "\\.[^.]+$" "" $name }}{{ end }}" />
          </a>
        </li>
      {{ end }}
    {{ end }}
  </ul>
{{ end }}
