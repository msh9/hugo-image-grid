{{/*
  Renders a responsive image grid.
  Inputs (one of):
  - images: slice of image Page Resources (links to image)
  - tiles: slice of dicts { img: image Resource, href: string }
  Options:
  - useThumbs (bool, default true): when true, use "<base>.thumbnail.*" sibling if present
*/}}
{{ $useThumbs := .useThumbs | default true }}
{{ $images := .images | default (slice) }}
{{ $tiles := .tiles | default (slice) }}
{{ $all := $images }}
{{ $renderTiles := gt (len $tiles) 0 }}
{{ $items := cond $renderTiles $tiles $images }}
{{ if gt (len $items) 0 }}
  <ul class="grid" aria-label="Image grid">
    {{ if $renderTiles }}
      {{ range $items }}
        {{ $img := .img }}
        {{ $href := .href | default $img.RelPermalink }}
        {{ $parent := .parent }}
        {{ $name := $img.Name }}
        {{ $src := $img.RelPermalink }}
        {{ if and $useThumbs (not (in (lower $name) ".thumbnail.")) }}
          {{ $siblings := slice }}
          {{ with $parent }}
            {{ $siblings = .Resources.ByType "image" }}
          {{ end }}
          {{ $base := lower (replaceRE "\\.[^.]+$" "" $name) }}
          {{ range $siblings }}
            {{ $c := lower .Name }}
            {{ if hasPrefix $c (printf "%s.thumbnail." $base) }}
              {{ $src = .RelPermalink }}
            {{ end }}
          {{ end }}
        {{ end }}
        <li class="grid-item">
          <a href="{{ $href }}">
            <img loading="lazy" decoding="async" src="{{ $src }}" alt="{{ with $img.Title }}{{ . }}{{ else }}{{ replaceRE "\\.[^.]+$" "" $name }}{{ end }}" />
          </a>
        </li>
      {{ end }}
    {{ else }}
      {{ range $items }}
        {{ $name := .Name }}
        {{ if not (in (lower $name) ".thumbnail.") }}
          {{ $src := .RelPermalink }}
          {{ if $useThumbs }}
            {{/* Find thumbnail among all provided images in the same directory */}}
            {{ $base := lower (replaceRE "\\.[^.]+$" "" $name) }}
            {{ $dir := replaceRE "/[^/]+$" "/" .RelPermalink }}
            {{ range $all }}
              {{ $cdir := replaceRE "/[^/]+$" "/" .RelPermalink }}
              {{ $cname := lower .Name }}
              {{ if and (eq $cdir $dir) (hasPrefix $cname (printf "%s.thumbnail." $base)) }}
                {{ $src = .RelPermalink }}
              {{ end }}
            {{ end }}
          {{ end }}
          <li class="grid-item">
            <a href="{{ .RelPermalink }}">
              <img loading="lazy" decoding="async" src="{{ $src }}" alt="{{ with .Title }}{{ . }}{{ else }}{{ replaceRE "\\.[^.]+$" "" $name }}{{ end }}" />
            </a>
          </li>
        {{ end }}
      {{ end }}
    {{ end }}
  </ul>
{{ end }}
